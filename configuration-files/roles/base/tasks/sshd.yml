---
# The result of this call is used to suppress the ssh.socket handler on older
# ubuntu releases where the socket unit is not present. Note that the drop-in
# is installed regardless of the result here. This is done to ensure ssh will
# start on the correct port after a dist-upgrade.
- name: ssh | check if systemd ssh.socket unit is active
  changed_when: false
  failed_when: false
  register: ssh_socket_is_active
  command:
    argv:
      - /usr/bin/systemctl
      - is-active
      - ssh.socket

- name: ssh | systemd ssh.socket unit drop-in directory present
  file:
    state: directory
    path: /etc/systemd/system/ssh.socket.d
    owner: root
    group: root
    mode: 0755

- name: ssh | systemd ssh.socket unit drop-in present
  notify:
    - restart ssh.socket
  copy:
    content: |
      [Socket]
      ListenStream=
      ListenStream=0.0.0.0:{{ network_port_ssh }}
      ListenStream=[::]:{{ network_port_ssh }}
    dest: /etc/systemd/system/ssh.socket.d/50-port.conf
    owner: root
    group: root
    mode: 0644

- name: ssh | configure sshd
  lineinfile:
    path: "/etc/ssh/sshd_config"
    regex: "^(#)?{{item.key}}"
    line: "{{item.key}} {{item.value}}"
    state: present
  loop:
    - { key: "AllowAgentForwarding", value: "no" } # disable tunneling feature
    - { key: "AllowTcpForwarding", value: "no" } # disable tunneling feature
    - { key: "ChallengeResponseAuthentication", value: "no" } # disable unused authentication method
    - { key: "GSSAPIAuthentication", value: "no" } # disable authentication method
    - { key: "KerberosAuthentication", value: "no" } # disable authentication method
    - { key: "PasswordAuthentication", value: "no" } # disable SSH password authentication
    - { key: "PermitEmptyPasswords", value: "no" } # disable authentication with empty passwords. This prevent logins if a userâ€™s password is set to a blank or empty value
    - { key: "PermitRootLogin", value: "no" } # disable logging in via SSH as the root user
    - { key: "PermitTunnel", value: "no" } # disable tunneling feature
    - { key: "Port", value: "{{ network_port_ssh }}" } # use custom listening port
    - { key: "X11Forwarding", value: "no" } # disable unused X11 forwarding, console access only
  notify:
    - restart ssh
